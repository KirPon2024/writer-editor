{
  "policyVersion": "v1.4",
  "promptMode": "prompt_disabled",
  "autoApplyWithinAllowlist": true,
  "denylistAbsolute": true,
  "allowlist": [
    "docs/OPERATIONS/**",
    "docs/ADR/**",
    "docs/FEATURES/**",
    "scripts/guards/**",
    "scripts/contracts/**",
    "test/contracts/**",
    "test/fixtures/**",
    "configs/**"
  ],
  "denylist": [
    "docs/OPS/**",
    "src/**",
    ".github/**",
    "package.json",
    "**/*lock*",
    "**/.env*",
    "**/secrets/**"
  ],
  "commandAllowlist": [
    "node scripts/contracts/check-codex-policy-schema.mjs",
    "node scripts/guards/check-codex-allowlist-boundary.mjs",
    "node scripts/guards/check-codex-denylist-boundary.mjs",
    "node scripts/contracts/check-codex-prompt-mode.mjs",
    "npm test -- test/contracts/codex-automation-policy.test.js"
  ],
  "dangerousOps": [
    "network",
    "secrets",
    "destructive",
    "out_of_allowlist_cmd"
  ],
  "promptDetection": {
    "markerRegex": "(permission|allowlist|approve|apply\\s+changes)",
    "exitCodeOnPrompt": 97
  },
  "AUTOMATION_HANDOFF_MINIMAL_CLICKS": {
    "handoffId": "AUTOMATION_HANDOFF_MINIMAL_CLICKS",
    "principle": "auto-everything-until-clicks",
    "stopOnlyOnHandoffStep": true,
    "classificationRules": [
      {
        "id": "GITHUB_UI_APPROVAL_OR_CONFIRMATION",
        "detectIfAny": [
          "protected file approval required",
          "required reviewer approval pending",
          "manual merge confirmation required in GitHub UI"
        ],
        "classifyAs": "HUMAN_ACTION_REQUIRED"
      },
      {
        "id": "OS_PROMPT_OR_KEYCHAIN",
        "detectIfAny": [
          "system prompt requires user confirmation",
          "keychain unlock prompt requires user confirmation",
          "security dialog requires manual approval"
        ],
        "classifyAs": "HUMAN_ACTION_REQUIRED"
      },
      {
        "id": "RUNNER_OR_APP_PERMISSION_CONFIRMATION",
        "detectIfAny": [
          "GitHub App permission confirmation required",
          "runner security approval required"
        ],
        "classifyAs": "HUMAN_ACTION_REQUIRED"
      },
      {
        "id": "REPO_POLICY_UI_MERGE_GATE",
        "detectIfAny": [
          "repository policy requires merge via UI interaction"
        ],
        "classifyAs": "HUMAN_ACTION_REQUIRED"
      },
      {
        "id": "WORKFLOW_SCOPE_MISSING_ON_PUSH",
        "detectIfAny": [
          "refusing to allow a personal access token to create or update workflow",
          "without 'workflow' scope",
          "PUSH_BLOCKED_MISSING_WORKFLOW_SCOPE"
        ],
        "classifyAs": "HUMAN_ACTION_REQUIRED"
      }
    ],
    "handoffPayloadSchema": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "humanActionRequired",
        "handoffReason",
        "clickList",
        "resumeFromStep",
        "artifacts"
      ],
      "properties": {
        "humanActionRequired": {
          "type": "boolean"
        },
        "handoffReason": {
          "type": "string"
        },
        "clickList": {
          "type": "array",
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "id",
              "surface",
              "action",
              "target",
              "expectedResult",
              "resumeFromStep"
            ],
            "properties": {
              "id": {
                "type": "string"
              },
              "surface": {
                "type": "string",
                "enum": [
                  "github_ui",
                  "os_prompt",
                  "keychain",
                  "other"
                ]
              },
              "action": {
                "type": "string"
              },
              "target": {
                "type": "string"
              },
              "expectedResult": {
                "type": "string"
              },
              "resumeFromStep": {
                "type": "string"
              }
            }
          }
        },
        "resumeFromStep": {
          "type": "string"
        },
        "artifacts": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "requiredFields": {
      "humanActionRequired": "boolean",
      "handoffReason": "string",
      "clickList[]": "array<clickStep>",
      "resumeFromStep": "string",
      "artifacts[]": "array<string>"
    },
    "examples": [
      {
        "name": "governance-approval-in-github-ui",
        "humanActionRequired": true,
        "handoffReason": "protected docs/OPS path requires manual approval in GitHub UI",
        "clickList": [
          {
            "id": "clk-001",
            "surface": "github_ui",
            "action": "Approve required review",
            "target": "https://github.com/<org>/<repo>/pull/<id>/files",
            "expectedResult": "Required reviewer approval turns green",
            "resumeFromStep": "STEP_12_MERGE"
          }
        ],
        "resumeFromStep": "STEP_12_MERGE",
        "artifacts": [
          "docs/OPS/GOVERNANCE_APPROVALS/GOVERNANCE_CHANGE_APPROVALS.json"
        ]
      },
      {
        "name": "keychain-or-system-prompt-unlock",
        "humanActionRequired": true,
        "handoffReason": "OS security/keychain prompt blocks non-interactive signing/auth step",
        "clickList": [
          {
            "id": "clk-101",
            "surface": "keychain",
            "action": "Confirm keychain unlock",
            "target": "macOS keychain prompt",
            "expectedResult": "Credential access granted for automation continuation",
            "resumeFromStep": "STEP_12_MERGE"
          }
        ],
        "resumeFromStep": "STEP_12_MERGE",
        "artifacts": [
          "os_prompt://security",
          "keychain://login"
        ]
      }
    ]
  },
  "autofixHooks": {
    "githubWorkflowScopePush": {
      "id": "GITHUB_WORKFLOW_SCOPE_PUSH_AUTOFIX",
      "triggerFailReason": "PUSH_BLOCKED_MISSING_WORKFLOW_SCOPE",
      "scriptPath": "scripts/ops/github-credential-autofix.mjs",
      "entryCommand": "node scripts/ops/github-credential-autofix.mjs --json --resume-from-step STEP_08_PUSH",
      "maxAutoRemediationAttempts": 3
    }
  },
  "runnerProfileRef": "docs/OPERATIONS/STATUS/CODEX_RUNNER_PROFILE.md",
  "failReasonRegistryRef": "docs/OPERATIONS/STATUS/CODEX_AUTOMATION_POLICY.json#/failReasons",
  "evidence": {
    "verifiedAt": null,
    "verifiedBy": "HO",
    "notes": "PR-1 bootstrap only; no synthetic validation yet"
  },
  "failReasons": [
    "ARTIFACT_MISSING",
    "POLICY_SCHEMA_INVALID",
    "ALLOWLIST_GUARD_FAIL",
    "DENYLIST_GUARD_FAIL",
    "PROMPT_MODE_UNPROVEN",
    "DENYLIST_BREACH",
    "ALLOWLIST_BREACH",
    "PROMPT_NOT_ELIMINATED",
    "DANGEROUS_OP_BLOCKED",
    "EVIDENCE_MISSING",
    "PUSH_BLOCKED_MISSING_WORKFLOW_SCOPE"
  ]
}

# CONTEXT (Craftsman vNext)

Этот файл — сжатая “память проекта” для быстрого входа нового агента/разработчика: что мы делаем, какие инварианты vNext, что уже решено и куда двигаться дальше.

## Как использовать (чтобы была “память” между аккаунтами)
- Верхний канон решений/изменений: `CANON.md` (свободная интерпретация запрещена).
- Канон проекта и дорожная карта: `docs/BIBLE.md`.
- Этот репозиторий — единственный источник “постоянной памяти” для будущих агентов: у модели нет гарантированной памяти между сессиями/аккаунтами.
- Держите `docs/CONTEXT.md` коротким: только устойчивые договорённости, ограничения, текущее состояние и ближайшие шаги.
- Для истории изменений используйте `docs/WORKLOG.md` (короткие пункты по датам). Туда же можно добавлять важные решения из переписок (не обязательно только про код).
- Не вставляйте сюда длинные логи чата целиком: лучше 3–10 буллетов “что решили / почему / что дальше”.
- Для новых задач используйте “Spec‑Lite” процесс и шаблоны: `docs/PROCESS.md` и `docs/templates/*`.
- Для передачи контекста между агентами используйте `npm run brain:handoff` (генерирует `docs/HANDOFF.md`).
- При смене аккаунта/агента: используйте `docs/AGENT_START_PROMPT.md` как первое сообщение.

## Протокол отклонений от плана (как мы “не уезжаем в сторону”)
Когда появляется новая идея/задача, которая не укладывается в текущий план, действуем так:
- Я помечаю это как **отклонение** и кратко объясняю риск (регрессии, усложнение, не соответствует канону/ТЗ, трогает ядро, добавляет зависимости, нарушает offline‑first / anti‑paywall).
- Я предлагаю 3 пути на выбор:
  1) **Остаться в плане** (самый безопасный путь).
  2) **Минимальный компромисс** (маленький шаг, который частично решает проблему без большой перестройки).
  3) **Перепланировать** (что выкидываем/что добавляем, какие риски и проверки).
- Любые изменения “ядра” (редактор/рендер/сохранение/undo) делаем **только этапами** с ручной проверкой после каждого этапа.
- Итоговое решение (что выбрали и почему) фиксируем 2–5 буллетами в `docs/WORKLOG.md`.
- Любые исключения из канона фиксируем в `docs/ARCH_DIFF_LOG.md` (с причиной и rollback).

Контрольные вопросы перед поворотом:
- Это точно нужно для MVP сейчас?
- Что именно рискуем сломать?
- Есть ли путь проще (без новой архитектуры/зависимостей)?
- Какие 2–3 проверки подтвердят, что не регресснули?

## Два режима работы (ChatGPT → Codex)
Чтобы не “зажимать” Codex и при этом держать процесс предсказуемым, работаем в 2 этапа:

- Этап 1 — **ChatGPT (Чат)**: формируем “ТЗ для Codex”, план этапов, промежуточные проверки и задаём до **3 уточняющих вопросов**. В этом режиме **не меняем файлы репозитория**.
- Этап 2 — **Codex (Агент)**: по готовому ТЗ **вносит правки в репозиторий по умолчанию**, работает этапами и делает проверки из ТЗ.
- Коммиты/push: делает **пользователь вручную**, если явно не попросили агента сделать commit/push.

## Snapshot: проект (vNext)
- Название: `craftsman` (desktop редактор для писателей)
- Технологии: Electron + HTML/CSS (с сохранением текущей UI‑геометрии)
- Режим: desktop‑first, offline‑first
- Канон/дорожная карта: `docs/BIBLE.md`

### Данные (vNext)
- Проект‑папка (format v1): `manifest.json`, `styles.json`, `scenes/*.ydoc`, `recovery/*.md`, `assets/*`, `backups/*`.
- Сцены — отдельные сущности (редактирование изолировано).
- Обязательные бэкапы + атомарная запись + recovery (читаемый слепок).

### Editor / storage (vNext)
- Draft editor: Tiptap/ProseMirror (OSS).
- Хранение сцены: `Y.Doc` per scene (в MVP без провайдера).
- Экспорт v1: DOCX первым.

### Важно про текущий код
Кодовая база находится в переходе: в текущей реализации ещё могут встречаться legacy‑решения (например `.txt`/contenteditable). Канон и план миграции — `docs/BIBLE.md`.

## Политики (канон)
### SECURITY_POLICY
- Electron: CSP обязателен; navigation blocked; new-window blocked; no remote code.
- IPC: allowlist каналов; payload validation; запрет путей/команд.

### DEPENDENCY_POLICY
- Allowlist (MVP): `esbuild`, `@tiptap/*` (OSS), `yjs`, DOCX lib (одна).
- Forbidden: `@tiptap-pro/*`, UI frameworks, state managers.
- CI: `npm audit` + OSS‑guard (`npm run oss:policy`).

### YJS FALLBACK
Если `.ydoc` повреждён: сцена read‑only, показывается `recovery.md`, возможна пересборка сцены.

## UI/UX договорённости
### Клавиатура и системные шорткаты (инвариант)
- На macOS при кастомном `Menu.setApplicationMenu(...)` обязательно должен быть `Edit` menu (role `editMenu` или набор role‑items `copy/paste/selectAll/...`), иначе могут перестать работать `Cmd+C/V/A/X/Z` даже в `contenteditable`/inputs.
- Если добавляем хоткеи в JS, ориентируемся на `event.code` (раскладка‑независимо), и не делаем глобальный `preventDefault()` “на всё с Cmd/Ctrl”.

### Рамки/разделители
- Рамка “страницы” `.editor-panel` должна совпадать по толщине/цвету с разделителем sidebar.
- Для этого рамка `.editor-panel` использует `var(--sidebar-border)` (и в светлой, и в тёмной теме через переопределение переменной).

### Toolbar: режимы `min/max`
- Кнопка `min/max` должна находиться в общем потоке тулбара (без “пустого растяжения” справа).
- По клику переключает компактный/полный режим тулбара, меняет текст `min` ⇄ `max`.
- В компактном режиме остаются только “минимальные” контролы (new + font/weight/size + line-height + кнопка), остальное скрыто.

## Текущее состояние (кратко)
- Milestone 0 выполнен: канон зафиксирован в `docs/BIBLE.md`, добавлены OSS‑guard и CI.
- Дальше работаем по roadmap в `docs/BIBLE.md` (M1: esbuild bundling → M2: Tiptap минимально → …).

## Референсы и лицензии
- Можно использовать сторонние open‑source редакторы как референс архитектуры/идей.
- Важно: KDE/ghostwriter вероятно под GPL → прямое копирование кода в проект недопустимо, если проект не готов принимать GPL. Лучше фиксировать идеи/паттерны в заметках.

## Следующие шаги (приоритет)
1) Milestone 1: сборка renderer (`esbuild`) без изменения UI.
2) Milestone 2: минимальный Tiptap editor (OSS) без смены хранения (временный bridge).
3) Milestone 3–4: проектный формат v1 + Yjs per scene + recovery.

# ТЗ для Codex: Sidebar — Роман: иерархия разделов + соединяющие линии

<!-- created: 2026-01-24 -->
<!-- suggested file: docs/tasks/2026-01-24--sidebar-roman-sections-tree.md -->

## Контекст / ограничения
- Технологии: Electron + vanilla HTML/CSS/JS
- Оффлайн, без сетевых запросов
- Формат хранения: `.txt` (plain text)
- Без новых зависимостей
- Изменения: `src/main.js`, `src/renderer/editor.js`, `src/renderer/styles.css`
- Не ломать: open/save/save-as, бэкапы, темы, focus-mode, текущую логику выделения в sidebar

## Референсы (скрины/видео/описание)
- Скрин 1: выделение активной категории/пункта (оставляем как есть).
- Скрин 2: новая иерархия “Роман → подпункты” + тонкие соединяющие линии.
- Figma: https://www.figma.com/design/wYJ92swWohUevBOLhHxfdz/Untitled?node-id=1-125&t=4bFWn2p5JWBHRYxf-4

### Дополнения по новому макету
- Верхний таб-блок содержит только одну категорию `Роман` (никаких `Материалы` / `Справочник`).
- Убрать лишний корневой “Роман”, оставляя только одну строку внутри дерева.
- Слева остаётся ровно одна тонкая вертикальная линия без дублирующих сегментов.
- Пояснение:
  1) Выделение при нажатии на “Роман” (как вкладка) и на “черновик” (как пункт) — оставить.
  2) Внутри sidebar нужна иерархия как на скрине 2.
  3) Перечень подпунктов фиксированный (все с маленькой буквы):
     - обложка
     - черновик
     - карта идей
     - чистовой текст
     - поток сознания
     - сны
     - статистика
  4) Линия соединяющая пункты должна быть тонкой/чёткой и соединять ВСЕ пункты без обрывов.

## Похожие паттерны (из нашей базы знаний)
> Перед реализацией: `npm run brain:refs -- "ключевые слова"` и добавить сюда ссылки.

- Команда: `npm run brain:refs -- "sidebar treeview иерархия линии соединяющая"`
- Релевантные заметки:
  - `docs/references/projects/bibisco.md`
  - `docs/references/projects/ghostwriter.md`

## Файлы
- `src/main.js`
- `src/renderer/editor.js`
- `src/renderer/styles.css`

## Проблема
- Как сейчас:
  - Вкладка “Роман” показывает дерево, построенное из структуры папок/файлов (части/главы/сцены).
  - Корневой узел “Роман” не виден как строка дерева (рендерятся только `treeRoot.children`).
  - Соединительные линии выглядят “обрывистыми” и не дают цельной связки пунктов (по референсу нужно иначе).
- Почему плохо:
  - UI не соответствует нужной навигации “Роман → фиксированные разделы”.
  - Нет стабильного набора пунктов: они зависят от содержимого папки.
  - Визуальная структура дерева (линии) не совпадает со скрином 2.

## Цель
- Как должно быть:
  - В sidebar (вкладка `roman`) отображается дерево:
    - Роман
      - обложка
      - черновик
      - карта идей
      - чистовой текст
      - поток сознания
      - сны
      - статистика
  - “Роман” — видимый корневой узел дерева (со стрелкой раскрытия).
  - При клике по любому подпункту открывается соответствующий `.txt` (создаётся, если отсутствует).
  - Выделение:
    - вкладка “Роман” подсвечивается как сейчас,
    - выбранный подпункт (например “черновик”) подсвечивается как сейчас.
  - Линии дерева:
    - тонкие/чёткие,
    - соединяют все подпункты без обрывов (как на скрине 2).

## Что сделать
> Список конкретных изменений. Избегаем “в целом улучшить”.

### Разметка (если нужно)
- Не добавлять новые зависимости/библиотеки.
- При необходимости добавить/скорректировать data-атрибуты/классы только внутри текущей структуры sidebar.

### Стили (если нужно)
- В `src/renderer/styles.css`:
  - довести линии дерева до “тонко/чётко” (как на скрине 2),
  - обеспечить непрерывность соединения всех пунктов (без визуальных разрывов между строками),
  - проверить светлую и тёмную темы.

### Логика (если нужно)
- `src/main.js`:
  - заменить построение дерева “Роман” на фиксированную структуру (корень “Роман” + 7 листьев).
  - каждый лист — узел с `path`, указывающим на файл в `.../roman/<имя>.txt`:
    - `обложка` → `.../roman/обложка.txt`
    - `черновик` → `.../roman/черновик.txt`
    - `карта идей` → `.../roman/карта идей.txt`
    - `чистовой текст` → `.../roman/чистовой текст.txt`
    - `поток сознания` → `.../roman/поток сознания.txt`
    - `сны` → `.../roman/сны.txt`
    - `статистика` → `.../roman/статистика.txt`
  - создание файла при отсутствии должно происходить через существующий `ui:open-document` (он уже создаёт файл при ENOENT).
  - (рекомендовано) завести отдельный `kind` для этих пунктов (например `roman-section`), чтобы не включать meta-панель как для `chapter-file/scene`.

- `src/renderer/editor.js`:
  - сделать так, чтобы в `roman` табе отображался видимый корневой узел “Роман” (а не только его children).
  - обеспечить открытие документов для нового типа узла (если добавлен новый `kind`).
  - не ломать текущее выделение строки: selected должен отражать `currentDocumentPath`.
  - привести контекстное меню в `roman` в соответствие новой структуре (если сейчас там есть пункты “Новая часть/глава/сцена”, которые больше не имеют смысла).

### Доступность (минимум)
- Кнопка раскрытия (chevron) должна оставаться кликабельной и с `aria-hidden="true"` на svg как сейчас.
- `button.tree__row` остаётся кнопкой (не превращать в div), чтобы сохранялась клавиатурная доступность.

## Критерии приёмки
- [ ] Во вкладке “Роман” отображается ровно: “Роман” + 7 подпунктов (строго в заданном порядке и с точными названиями/регистром).
- [ ] Клик по подпункту открывает/создаёт соответствующий `.txt` файл в папке `roman`.
- [ ] Подсветка вкладки “Роман” и выбранного пункта (например “черновик”) сохраняется как раньше.
- [ ] Соединительная линия дерева тонкая/чёткая и визуально соединяет все пункты без обрывов (как на скрине 2).
- [ ] Светлая и тёмная тема выглядят корректно.

## Промежуточные тестирования (после каждого шага)
Тест 1 — после шага 1 (фиксированное дерево “Роман”):
- Команда: `npm run dev`
- Проверить:
  - “Роман” + 7 подпунктов отображаются в sidebar.
  - Клик по “черновик” открывает документ, строка выделяется.

Тест 2 — после шага 2 (отображение корня “Роман” + поведение раскрытия):
- Проверить:
  - “Роман” виден как строка дерева, стрелка раскрытия работает.
  - Клик по “Роман” не ломает выделение текущего открытого документа.

Тест 3 — после шага 3 (линии дерева):
- Проверить:
  - линии тонкие/чёткие, нет “разрывов” между строками,
  - светлая/тёмная тема.

Тест 4 — регрессии:
- Использовать `docs/templates/REGRESSION_CHECKLIST.md`.

## Уточнения (максимум 3 вопроса, только high‑impact)
Q1: “статистика” — это пока обычный `.txt` документ (заметки), или нужен отдельный экран со статистикой уже сейчас?
Q2: “карта идей” — тоже `.txt` (список/заметки) на MVP, верно?
Q3: При клике по корню “Роман” нужно только раскрытие/сворачивание (без открытия файла), верно?

## Риски и откат
- Что может сломаться:
  - UX/контекстное меню во вкладке `roman`, если останутся действия, создающие элементы, которые больше не видны в дереве.
  - Показ meta-панели, если использовать существующие `kind` (`chapter-file`) вместо отдельного `roman-doc`.
- Как быстро откатить (минимальный rollback‑план):
  - Вернуть старую реализацию `buildRomanTree()` в `src/main.js`.
  - Вернуть прежний режим рендера дерева в `src/renderer/editor.js` (рендер `treeRoot.children`).
  - Откатить изменения CSS линий в `src/renderer/styles.css`.

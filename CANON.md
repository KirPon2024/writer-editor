# CRAFTSMAN vNext — КАНОН РЕШЕНИЙ И УПРАВЛЕНИЯ ИЗМЕНЕНИЯМИ
## Единый файл. Каноническая версия. Свободная интерпретация запрещена.

---

## 0. Назначение документа

Этот файл — **единый канон**, по которому:

- ChatGPT **формирует ТЗ** (без домыслов),
- Codex **исполняет ТЗ** (без фантазий),
- человек **принимает решения и мержит**.

Документ:
- фиксирует архитектуру,
- фиксирует процесс,
- фиксирует границы,
- фиксирует текущие решения по спорным вопросам,
- предотвращает расползание scope и diff budget.

Любые изменения канона:
- **только отдельным ТЗ**,
- **только осознанно**,
- **никогда “по ходу”**.

---

## 1. Базовые инварианты проекта (НЕ НАРУШАТЬ)

### 1.1 Продуктовые

- Desktop-first
- Offline-first
- Один продукт → разные оболочки (desktop → web → mobile)
- Сцены = изолированные сущности
- Редактирование ≠ финальная верстка
- Данные не заперты (recovery обязателен)

### 1.2 Архитектурные

- UI (editor surface) ≠ источник истины
- Core ≠ Renderer
- Экспорт = отдельный pipeline
- Коллаб = поверх CRDT, не поверх DOM
- Никаких paywall-зависимостей

### 1.3 Процессные

- Один milestone = один тип задач
- Один PR = один вертикальный срез
- Docs / CI / guards **никогда** не смешиваются с `src/**`
- Diff budget обязателен

---

## 2. Milestone 0 — ЧИСТОТА И КАНОН

### 2.1 Что входит в Milestone 0

- docs/**
- CI / guards / policies
- архитектурные каноны
- запреты и ограничения

### 2.2 Что ЗАПРЕЩЕНО в Milestone 0

- любые изменения в `src/**`
- любые поведенческие правки
- любые UI-риски
- любые “заодно”

Milestone 0 = **ноль регрессий**.

---

## 3. Состояние `editor.js` (ФАКТЫ)

### 3.1 В `editor.js` смешаны ДВЕ темы

#### A) Page-size calibration
(по ТЗ `2026-01-26--page-size-calibration.md`)

Сделано:
- `PX_PER_MM_AT_ZOOM_1 = 595 / 210`
- `PAGE_GAP_MM = 20 / (595 / 210)`

Статус:
- логически завершено
- процессно НЕ ЗАКРЫТО (нет ручной проверки)

#### B) Поведенческие правки редактора (НЕ из этого ТЗ)

Обнаружено:
- debounce пагинации и перерендера
- защита от programmatic input
- изменение input pipeline
- правки caret / selection
- pointer-drag логика
- `Enter` через `execCommand`

Статус:
- это отдельная тема
- не проверено
- не имеет ТЗ
- нарушает diff budget
- ломает чистоту Milestone 0

---

## 4. Почему `editor.js` — НЕ Milestone 0

- Milestone 0 = docs + CI
- `editor.js` = `src/**`
- Поведенческие правки = UI-риск
- Нет Definition of Done
- Нет регресс-чеклиста

**Вывод:**  
`editor.js` не может быть частью Milestone 0 ни при каких условиях.

---

## 5. ОБЯЗАТЕЛЬНОЕ РЕШЕНИЕ (ФИКСИРУЕТСЯ)

### 5.1 Для Milestone 0

- `editor.js` **УБИРАЕТСЯ** из текущего набора изменений
- Milestone 0 мержится чисто:
  - docs
  - CI
  - guards
  - policies

---

## 6. Что делать с текущими правками `editor.js`

Допустимы **ТОЛЬКО два варианта**.

### Вариант A (РЕКОМЕНДУЕТСЯ)
**STASH**

- сохранить правки как WIP (stash или отдельная ветка)
- не мержить
- вернуться ТОЛЬКО с отдельным ТЗ:
  > “Editor behavior changes v1”

### Вариант B
**ЖЁСТКИЙ ОТКАТ**

- откатить `editor.js` полностью
- правки считаются отклонёнными

❌ Частичное сохранение — запрещено.

---

## 7. Если закрывается ТОЛЬКО page-size calibration

### Условия

- `editor.js` предварительно очищен
- применяются ТОЛЬКО 2 строки:
  - `PX_PER_MM_AT_ZOOM_1`
  - `PAGE_GAP_MM`
- никаких иных изменений

### Обязательная ручная проверка (DevTools)

#### Размер страницы (A4, device px)

```js
const page = document.querySelector('.editor-page-wrap');
const r = page.getBoundingClientRect();
const dpr = window.devicePixelRatio || 1;
[Math.round(r.width * dpr), Math.round(r.height * dpr)]
```

Ожидание: `[595, 842]`

#### Gap (device px)

```js
const pages = document.querySelectorAll('.editor-page-wrap');
const r1 = pages[0].getBoundingClientRect();
const r2 = pages[1].getBoundingClientRect();
const dpr = window.devicePixelRatio || 1;
Math.round((r2.top - r1.bottom) * dpr)
```

Ожидание: `20`

Без этого задача считается **НЕ ЗАКРЫТОЙ**.

---

## 8. Безопасность (ЧАСТЬ КАНОНА)

### 8.1 Electron

- `nodeIntegration = false`
- `contextIsolation = true`
- CSP: `default-src 'self'`
- IPC — строго валидируется (schema)
- удалённый контент только без Node

### 8.2 Зависимости

- регулярный `npm audit`
- фиксация минимальных безопасных версий
- запрет `@tiptap-pro/*`

### 8.3 Yjs / коллаб (будущее)

- лимиты размера update
- валидация обновлений
- auth + ACL
- подготовка к шифрованию

### 8.4 Paste / XSS

- paste только `text/plain`
- запрет `javascript:` и `data:` URI
- нормализация всех входящих данных

---

## 9. Форматы данных

- все файлы версионируются
- JSON Schema для каждого формата
- атомарная запись
- recovery обязателен

---

## 10. Производительность

- лимиты на размер `.ydoc`
- compaction snapshots
- виртуализация сцен
- KPI загрузки сцен

---

## 11. Mind maps (MVP и будущее)

### MVP

- mindmap = data + svg
- никакой типографики
- embed как картинка

### Будущее

- versioned format
- миграции
- переход от дерева к графу возможен

---

## 12. Процесс ChatGPT → Codex

### ChatGPT

- НЕ додумывает
- следует этому канону
- пишет детерминированные ТЗ

### Codex

- исполняет строго по ТЗ
- не выходит за diff budget
- не “улучшает”

---

## 13. Усиление контроля (НЕ ОБЯЗАТЕЛЬНО)

Можно добавить:

- `STAGE_MATRIX.md` — Stage × Rules
- `CODEX_CHECKLIST.md` — чек-лист перед PR
- `ARCH_DIFF_LOG.md` — журнал исключений

Это не мешает масштабированию, но повышает контроль.

---

## 14. Статус документа

- документ канонический
- используется как единый источник истины
- любые изменения — только отдельным ТЗ
- нарушение канона = ошибка процесса

---

## 15. Финальная фиксация

- `editor.js` НЕ часть Milestone 0
- поведенческие правки — отдельная задача
- Milestone 0 = docs + CI
- свободная интерпретация запрещена

КАНОН ЗАКРЫТ.

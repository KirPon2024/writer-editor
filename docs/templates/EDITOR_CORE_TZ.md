# ТЗ для Codex: изменения “ядра редактора” (editor/renderer/undo/save)

> Этот шаблон — для задач, которые трогают `editor` (ввод, выделение, рендер, сохранение, undo/redo).
> Такие изменения делаем **только этапами** и всегда проверяем регрессии.

## Контекст / ограничения
- Технологии: Electron + vanilla HTML/CSS/JS
- Оффлайн, без сетевых запросов
- Формат хранения: `.txt` (plain text)
- Без новых зависимостей
- Не ломать: save/open, бэкапы, темы, focus-mode, wrap, word count

## Референсы (скрины/видео/описание)
- Скрин/видео: …
- Как должно работать: …

## Похожие паттерны (из нашей базы знаний)
> Перед реализацией: `npm run brain:refs -- "ключевые слова"` и добавить сюда ссылки.

- Релевантные заметки:
  - …

## Файлы (почти всегда)
- `src/renderer/index.html`
- `src/renderer/styles.css`
- `src/renderer/editor.js`

## Проблема
- Как сейчас: …
- Почему это критично: …

## Цель
- Как должно быть: …

## Не‑цели (что точно не делаем)
- Не добавляем новый формат хранения (только `.txt`)
- Не добавляем зависимости/библиотеки
- Не добавляем сетевые функции

## Что сделать (общий список)
### Поведение/логика
- …

### Рендер/DOM (если нужно)
- …

### Данные/хранение
- Всегда сохраняем/открываем **plain text** (без HTML)
- Бэкапы/автосейв работают как раньше

### Доступность (минимум)
- tab‑order/клавиатура для интерактива
- aria-label где уместно

## Критерии приёмки
- [ ] …
- [ ] …

## Этапы и промежуточные тестирования

### Этап 1 — “инфраструктура / безопасная перестройка”
Цель: подготовить почву и не сломать ввод/сохранение.

Сделать:
- …

Тест 1:
- Команда: `npm run dev`
- Проверить ввод: печать, `Enter`, `Backspace`, выделение мышью/клавиатурой
- Paste: вставляется только `text/plain` (без HTML)
- `Save`/`Open` работают, текст не портится
- Word count обновляется
- Нет ошибок в консоли

### Этап 2 — “функциональность (минимальный MVP)”
Цель: реализовать основное поведение, закрыть базовые сценарии.

Сделать:
- …

Тест 2:
- Пройти основной сценарий из ТЗ (минимум 2–3 кейса)
- Проверить курсор/выделение после операций (вставка/применение/удаление)
- Перезапуск приложения: состояние/настройки сохраняются (если ожидается)

### Этап 3 — “краевые случаи / UX‑полировка”
Цель: убрать “ломающие” углы (selection offsets, многострочные операции, пустые строки).

Сделать:
- …

Тест 3:
- Большой документ: 2–3 страницы текста → печатать без заметных лагов
- Быстро повторить действия 10–20 раз (не должно “залипать”)
- Проверить тёмную/светлую тему, wrap, focus-mode

### Этап 4 — “undo/redo и финальные регрессии”
Цель: убедиться, что не убили предсказуемость редактирования.

Сделать (если нужно):
- Если нативный undo/redo ломается из-за перерендера — добавить простой undo‑стек (plain text + caret offsets)

Тест 4:
- Undo/Redo: `Cmd/Ctrl+Z` / `Cmd/Ctrl+Shift+Z` (или `Ctrl+Y`) — работает предсказуемо
- Полный регресс‑прогон: `docs/templates/REGRESSION_CHECKLIST.md`

## Уточнения (максимум 3 вопроса, только high‑impact)
Q1:
Q2:
Q3:

## Риски и откат
- Что может сломаться: ввод/выделение/сохранение/undo/производительность
- Как быстро откатить: revert коммита/патча; восстановить предыдущий компонент/хелперы

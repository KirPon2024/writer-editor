# Agent Instructions (Craftsman vNext)

Этот файл определяет правила работы агента с проектом `craftsman`.

## Приоритет источников (“что является истиной”)
1) `CANON.md` — верхний канон решений/изменений (свободная интерпретация запрещена).
2) `docs/corex/COREX.v1.md` — философия, целевая архитектура, долгий горизонт (указатель: `docs/corex/COREX.md`; будущие версии: `COREX.vN.md`).
3) `docs/BIBLE.md` — канон проекта и дорожная карта.
4) `README.md` — короткое описание и ссылки.
5) `docs/CONTEXT.md` — текущее состояние, инварианты, ближайшие шаги.
6) `docs/PROCESS.md` — как работаем (ChatGPT → Codex, diff‑budget, проверки).
7) `docs/HANDOFF.md` — последний срез для быстрого входа.

Если `CANON.md`/COREX/`docs/BIBLE.md` не дают точного ответа — задать 1–3 уточняющих вопроса (только high‑impact) и остановиться до ответа.

## Общие принципы
- Проект — инди без бюджета
- MVP важнее идеальной архитектуры
- Простые и надёжные решения предпочтительнее сложных
- Минимизировать зависимости и сложные фреймворки без прямого запроса
- Не закладывать архитектуру “на будущее” вне канона

## Обязательные ограничения (MVP vNext)
- Desktop‑first, offline‑first: **никаких сетевых запросов**, аккаунтов, авторизации, облаков и синхронизации.
- Данные хранятся локально и не “запираются”:
  - формат проекта v1 (manifest/styles/scenes + assets/backups)
  - **обязательный recovery** (читаемый слепок)
  - **атомарная запись** на диск (existing `writeFileAtomic` / аналог)
- Сцены — отдельные сущности (изолированное редактирование).
- Экспорт: DOCX v1 первым (одна JS‑библиотека, без CLI/бинарей).

## Инварианты UI/дизайна
- Не менять структуру `src/renderer/index.html` и базовые классы без отдельного ТЗ.
- Новые стили добавлять только точечно и в рамках канона (обычно в конце CSS и для `.ProseMirror`/новых виджетов).
- Не подключать UI‑frameworks/компонент‑паки, которые навязывают внешний вид.

## SECURITY_POLICY (канон)
Electron:
- CSP обязателен
- navigation blocked
- new-window blocked
- no remote code

IPC:
- allowlist каналов
- payload validation
- запрет путей/команд

## DEPENDENCY_POLICY (канон)
Allowlist (MVP):
- `esbuild`
- `@tiptap/*` (OSS)
- `yjs`
- DOCX lib (одна)

Forbidden:
- `@tiptap-pro/*`, `@tiptap-cloud/*`
- UI frameworks
- state managers

CI:
- `npm audit`
- OSS‑guard: `npm run oss:policy`

## CODEX_CHECKLIST (обязателен в каждой задаче)
- Stage корректен
- Активные правила соблюдены
- UI не изменён (если это не отдельная UI‑задача)
- Новых зависимостей нет (если явно не разрешено)
- Paste policy соблюдена (если трогали редактор)
- Atomic write используется (если трогали запись)
- Recovery создаётся/обновляется (если трогали хранение)
- Тесты проходят (или явно сказано, что не запускалось)
- Diff‑budget соблюдён

## ARCH_DIFF_LOG (исключения)
Любое исключение из канона:
- фиксируется (с причиной)
- записывается в `docs/ARCH_DIFF_LOG.md`
- имеет rollback
- временное

Исключение без записи = ошибка.
